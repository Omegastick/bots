name: artificial_insentience
on: [push]

jobs:
  job:
    name: ${{ matrix.os }}-build
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        include:
          - os: windows-latest
            torchInstallDir: 'C:/libtorch/'
            triplet: x64-windows-static
            vcpkgRoot: '/usr/local/share/vcpkg'
          - os: ubuntu-latest
            torchInstallDir: '/tmp/libtorch'
            triplet: 'x64-linux'
            vcpkgRoot: 'C:/vcpkg'          
    steps:
      - name: Install curl
        run: vcpkg install curl:${{ matrix.triplet }}
      - name: Install PyTorch on Linnux
        if: matrix.os == 'ubuntu-latest'
        run: |
            wget https://download.pytorch.org/libtorch/cpu/libtorch-shared-with-deps-1.3.0%2Bcpu.zip -O /tmp/libtorch.zip
            unzip /tmp/libtorch.zip -d /tmp/
      - name: Install PyTorch on Windows
        if: matrix.os == 'windows-latest'
        run: |
          curl -fsS -o libtorch.zip https://download.pytorch.org/libtorch/cpu/libtorch-win-shared-with-deps-1.3.0.zip
          7z x libtorch.zip -y -oC:\
          $env:Path += ";C:\libtorch\lib"
      - uses: actions/checkout@v2
      - name: Checkout submodules
        run: |
          git submodule sync --recursive
          git submodule update --init --recursive
      - name: Configure
        run: |
          mkdir build
          cd build
          cmake -DCMAKE_PREFIX_PATH=${{ matrix.torchInstallDir }} -DCMAKE_TOOCHAIN_FILE=${{ matrix.vcpkgRoot }}/scripts/buildsystems/vcpkg.cmake -DVCPKG_TARGET_TRIPLET=x${{ matrix.triplet }} ..
      - name: Build on Linux
        if: matrix.os == 'ubuntu_latest'
        run: cmake --build .
      - name: Build on Windows
        if: matrix.os == 'windows_latest'
        run: cmake --build . --config Debug
